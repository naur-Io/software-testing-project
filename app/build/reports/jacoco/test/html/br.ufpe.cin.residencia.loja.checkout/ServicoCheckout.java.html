<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServicoCheckout.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">br.ufpe.cin.residencia.loja.checkout</a> &gt; <span class="el_source">ServicoCheckout.java</span></div><h1>ServicoCheckout.java</h1><pre class="source lang-java linenums">package br.ufpe.cin.residencia.loja.checkout;

import br.ufpe.cin.residencia.loja.catalogo.Catalogo;
import br.ufpe.cin.residencia.loja.descontos.CodigoCupom;
import br.ufpe.cin.residencia.loja.descontos.Cupom;
import br.ufpe.cin.residencia.loja.descontos.PoliticaCupom;
import br.ufpe.cin.residencia.loja.descontos.RepositorioCupom;
import br.ufpe.cin.residencia.loja.dominio.Carrinho;
import br.ufpe.cin.residencia.loja.dominio.Dinheiro;
import br.ufpe.cin.residencia.loja.dominio.LinhaCarrinho;
import br.ufpe.cin.residencia.loja.dominio.Item;
import br.ufpe.cin.residencia.loja.frete.CalculadoraFrete;
import br.ufpe.cin.residencia.loja.frete.MetodoFrete;
import br.ufpe.cin.residencia.loja.pagamento.MetodoPagamento;
import br.ufpe.cin.residencia.loja.pagamento.PoliticaDescontoPagamento;
import br.ufpe.cin.residencia.loja.precificacao.CalculadoraImposto;
import br.ufpe.cin.residencia.loja.precificacao.Recibo;
import br.ufpe.cin.residencia.loja.pedidos.ItemPedido;
import br.ufpe.cin.residencia.loja.pedidos.Pedido;
import br.ufpe.cin.residencia.loja.pedidos.StatusPedido;
import br.ufpe.cin.residencia.loja.persistencia.RepositorioPedidos;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

public class ServicoCheckout {
    private final Catalogo catalogo;
    private final RepositorioCupom repositorioCupom;
    private final RepositorioPedidos repositorioPedidos;
<span class="fc" id="L33">    private final CalculadoraFrete calculadoraFrete = new CalculadoraFrete();</span>
<span class="fc" id="L34">    private final PoliticaCupom politicaCupom = new PoliticaCupom();</span>
<span class="fc" id="L35">    private final PoliticaDescontoPagamento politicaDescontoPagamento = new PoliticaDescontoPagamento();</span>
<span class="fc" id="L36">    private final CalculadoraImposto calculadoraImposto = new CalculadoraImposto();</span>

    public ServicoCheckout(Catalogo catalogo, RepositorioCupom repositorioCupom,
<span class="fc" id="L39">                           RepositorioPedidos repositorioPedidos) {</span>
<span class="pc bpc" id="L40" title="2 of 6 branches missed.">        if (catalogo == null || repositorioCupom == null || repositorioPedidos == null) {</span>
<span class="fc" id="L41">            throw new IllegalArgumentException(&quot;Catálogo, repositório de cupom e pedidos são obrigatórios.&quot;);</span>
        }
<span class="fc" id="L43">        this.catalogo = catalogo;</span>
<span class="fc" id="L44">        this.repositorioCupom = repositorioCupom;</span>
<span class="fc" id="L45">        this.repositorioPedidos = repositorioPedidos;</span>
<span class="fc" id="L46">    }</span>

    public ResultadoCheckout finalizarCompra(Carrinho carrinho, MetodoFrete frete, MetodoPagamento pagamento,
                                             CodigoCupom codigoCupomOpcional) {
<span class="fc" id="L50">        validarEntrada(carrinho, frete, pagamento);</span>
<span class="fc" id="L51">        validarEstoque(carrinho);</span>

<span class="fc" id="L53">        Cupom cupom = obterCupom(codigoCupomOpcional);</span>

<span class="fc" id="L55">        Dinheiro subtotal = carrinho.subtotal();</span>
<span class="fc" id="L56">        int pesoTotal = carrinho.pesoTotalEmGramas();</span>

<span class="fc" id="L58">        Dinheiro descontoCupom = calcularDescontoCupom(cupom, subtotal);</span>
<span class="fc" id="L59">        Dinheiro baseDescontoPagamento = subtotal.subtrair(descontoCupom).clampMinZero();</span>

<span class="fc" id="L61">        Dinheiro descontoPagamento = calcularDescontoPagamento(pagamento, cupom, baseDescontoPagamento, subtotal);</span>

<span class="fc" id="L63">        Dinheiro imposto = calcularImposto(subtotal, descontoCupom, descontoPagamento);</span>
<span class="fc" id="L64">        Dinheiro freteFinal = calcularFrete(frete, subtotal, pesoTotal, cupom);</span>
<span class="fc" id="L65">        Dinheiro total = calcularTotal(subtotal, descontoCupom, descontoPagamento, imposto, freteFinal);</span>

<span class="fc" id="L67">        Recibo recibo = new Recibo(subtotal, descontoCupom, descontoPagamento, imposto, freteFinal, total);</span>
<span class="fc" id="L68">        Pedido pedido = criarPedido(carrinho, frete, pagamento, codigoCupomOpcional, recibo);</span>

<span class="fc" id="L70">        aplicarEfeitosColaterais(carrinho, cupom, pedido);</span>
<span class="fc" id="L71">        return new ResultadoCheckout(recibo, pedido.getId());</span>
    }

    private void validarEntrada(Carrinho carrinho, MetodoFrete frete, MetodoPagamento pagamento) {
<span class="fc bfc" id="L75" title="All 6 branches covered.">        if (carrinho == null || frete == null || pagamento == null) {</span>
<span class="fc" id="L76">            throw new IllegalArgumentException(&quot;Entradas obrigatórias não podem ser nulas.&quot;);</span>
        }
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (carrinho.vazio()) {</span>
<span class="fc" id="L79">            throw new IllegalArgumentException(&quot;Carrinho vazio não pode finalizar compra.&quot;);</span>
        }
<span class="fc" id="L81">    }</span>

    private Cupom obterCupom(CodigoCupom codigoCupomOpcional) {
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (codigoCupomOpcional == null) {</span>
<span class="fc" id="L85">            return null;</span>
        }
<span class="fc" id="L87">        Cupom cupom = repositorioCupom.obter(codigoCupomOpcional);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (cupom == null) {</span>
<span class="fc" id="L89">            throw new ExcecaoCupomInvalido(&quot;Cupom inexistente: &quot; + codigoCupomOpcional);</span>
        }
<span class="fc" id="L91">        politicaCupom.validarCupom(cupom);</span>
<span class="fc" id="L92">        return cupom;</span>
    }

    private Dinheiro calcularDescontoCupom(Cupom cupom, Dinheiro subtotal) {
<span class="fc" id="L96">        return politicaCupom.descontoNoSubtotal(cupom, subtotal);</span>
    }

    private Dinheiro calcularDescontoPagamento(MetodoPagamento pagamento, Cupom cupom,
                                               Dinheiro baseDescontoPagamento, Dinheiro subtotal) {
<span class="fc" id="L101">        Dinheiro descontoPagamento = politicaDescontoPagamento.descontoPorPagamento(</span>
                pagamento, cupom, baseDescontoPagamento);

<span class="pc bpc" id="L104" title="1 of 4 branches missed.">        if (pagamento == MetodoPagamento.BOLETO &amp;&amp; !subtotal.maiorOuIgual(Dinheiro.of(&quot;200.00&quot;))) {</span>
<span class="fc" id="L105">            descontoPagamento = Dinheiro.zero();</span>
        }

<span class="fc" id="L108">        return descontoPagamento.min(baseDescontoPagamento);</span>
    }

    private Dinheiro calcularImposto(Dinheiro subtotal, Dinheiro descontoCupom, Dinheiro descontoPagamento) {
<span class="fc" id="L112">        Dinheiro baseImposto = subtotal.subtrair(descontoCupom).subtrair(descontoPagamento).clampMinZero();</span>
<span class="fc" id="L113">        return calculadoraImposto.calcularImposto(baseImposto);</span>
    }

    private Dinheiro calcularFrete(MetodoFrete frete, Dinheiro subtotal, int pesoTotal, Cupom cupom) {
<span class="fc" id="L117">        Dinheiro freteCalculado = calculadoraFrete.custoFrete(frete, subtotal, pesoTotal);</span>
<span class="pc bpc" id="L118" title="2 of 4 branches missed.">        boolean freteGratisPromocao = frete == MetodoFrete.PADRAO &amp;&amp; subtotal.maiorOuIgual(Dinheiro.of(&quot;250.00&quot;));</span>
<span class="fc" id="L119">        boolean freteGratisCupom = politicaCupom.freteDeveSerGratis(cupom, frete, subtotal);</span>
<span class="pc bpc" id="L120" title="2 of 4 branches missed.">        return (freteGratisPromocao || freteGratisCupom) ? Dinheiro.zero() : freteCalculado;</span>
    }

    private Dinheiro calcularTotal(Dinheiro subtotal, Dinheiro descontoCupom, Dinheiro descontoPagamento,
                                   Dinheiro imposto, Dinheiro freteFinal) {
<span class="fc" id="L125">        Dinheiro total = subtotal.subtrair(descontoCupom)</span>
<span class="fc" id="L126">                .subtrair(descontoPagamento)</span>
<span class="fc" id="L127">                .somar(imposto)</span>
<span class="fc" id="L128">                .somar(freteFinal);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (total.ehNegativo()) {</span>
<span class="nc" id="L130">            throw new ExcecaoTotalInvalido(&quot;Total negativo não é permitido.&quot;);</span>
        }
<span class="fc" id="L132">        return total;</span>
    }

    private void registrarUsoCupom(Cupom cupom) {
<span class="pc bpc" id="L136" title="1 of 4 branches missed.">        if (cupom != null &amp;&amp; cupom.isUsoUnico()) {</span>
<span class="fc" id="L137">            repositorioCupom.marcarComoUsado(cupom.getCodigo());</span>
        }
<span class="fc" id="L139">    }</span>

    private Pedido criarPedido(Carrinho carrinho, MetodoFrete frete, MetodoPagamento pagamento,
                               CodigoCupom codigoCupom, Recibo recibo) {
<span class="fc" id="L143">        List&lt;ItemPedido&gt; itens = carrinho.linhas().stream()</span>
<span class="fc" id="L144">                .map(linha -&gt; {</span>
<span class="fc" id="L145">                    Item item = linha.getItem();</span>
<span class="fc" id="L146">                    return new ItemPedido(item.getSku(), item.getNome(), item.getPrecoUnitario(),</span>
<span class="fc" id="L147">                            item.getPesoEmGramas(), linha.getQuantidade());</span>
                })
<span class="fc" id="L149">                .collect(java.util.stream.Collectors.toList());</span>
<span class="fc" id="L150">        return new Pedido(UUID.randomUUID().toString(), LocalDateTime.now(), null, itens,</span>
                frete, pagamento, codigoCupom,
                recibo.subtotal, recibo.descontoCupom, recibo.descontoPagamento,
                recibo.imposto, recibo.frete, recibo.total, StatusPedido.PAGO);
    }

    private void aplicarEfeitosColaterais(Carrinho carrinho, Cupom cupom, Pedido pedido) {
<span class="fc" id="L157">        Map&lt;String, Integer&gt; totais = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">        for (LinhaCarrinho linha : carrinho.linhas()) {</span>
<span class="fc" id="L159">            Item item = linha.getItem();</span>
<span class="fc" id="L160">            totais.merge(item.getSku(), linha.getQuantidade(), Integer::sum);</span>
<span class="fc" id="L161">        }</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        for (Map.Entry&lt;String, Integer&gt; entrada : totais.entrySet()) {</span>
<span class="fc" id="L163">            catalogo.baixarEstoque(entrada.getKey(), entrada.getValue());</span>
<span class="fc" id="L164">        }</span>
<span class="fc" id="L165">        repositorioPedidos.salvar(pedido);</span>
<span class="fc" id="L166">        registrarUsoCupom(cupom);</span>
<span class="fc" id="L167">    }</span>

    private void validarEstoque(Carrinho carrinho) {
<span class="fc" id="L170">        Map&lt;String, Integer&gt; totais = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        for (LinhaCarrinho linha : carrinho.linhas()) {</span>
<span class="fc" id="L172">            Item item = linha.getItem();</span>
<span class="fc" id="L173">            totais.merge(item.getSku(), linha.getQuantidade(), Integer::sum);</span>
<span class="fc" id="L174">        }</span>

<span class="fc bfc" id="L176" title="All 2 branches covered.">        for (Map.Entry&lt;String, Integer&gt; entrada : totais.entrySet()) {</span>
<span class="fc" id="L177">            String sku = entrada.getKey();</span>
<span class="fc" id="L178">            int quantidadeSolicitada = entrada.getValue();</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">            if (catalogo.obterPorSku(sku) == null) {</span>
<span class="fc" id="L180">                throw new ExcecaoSemEstoque(&quot;SKU inexistente no catálogo: &quot; + sku);</span>
            }
<span class="fc" id="L182">            int estoque = catalogo.estoquePara(sku);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">            if (estoque &lt; quantidadeSolicitada) {</span>
<span class="fc" id="L184">                throw new ExcecaoSemEstoque(&quot;Sem estoque para SKU: &quot; + sku);</span>
            }
<span class="fc" id="L186">        }</span>
<span class="fc" id="L187">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>